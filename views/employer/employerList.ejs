<%- layout('/layouts/boilerplate.ejs') -%>
<div class="container py-5">
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <% if (jobs.length > 0) { %>
      <% jobs.forEach(job => {
           if (job.status === "Open") {
           const shortDesc = job.description ? job.description.split(" ").slice(0, 20).join(" ") + "..." : "No description available";
           const skillsToShow = job.requiredSkills.slice(0, 4); // First 4 skills
      %>
        <div class="col">
          <div class="card h-100 border-0 shadow-sm hover-shadow transition rounded-4 p-3 d-flex flex-column">
            <div class="card-body d-flex flex-column">

              <!-- Employer Info -->
              <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle overflow-hidden me-3" style="width: 60px; height: 60px;">
                  <img src="<%= job.employerId.profilePicture?.url || '/placeholder.svg' %>"
                       alt="<%= job.employerId.name %>"
                       class="w-100 h-100"
                       style="object-fit: cover;">
                </div>
                <div>
                  <h5 class="fw-semibold mb-0 text-dark"><%= job.employerId.name %></h5>
                </div>
              </div>

              <!-- Job Title -->
              <h5 class="card-title fw-bold mb-2 text-dark"><%= job.title %></h5>

              <!-- Budget -->
              <p class="mb-2 text-muted">
                <i class="bi bi-currency-rupee me-1"></i>
                <strong>Budget:</strong> â‚¹<%= job.budget %>
              </p>

              <!-- Skills -->
              <p class="mb-2 text-muted">
                <i class="bi bi-tools me-1"></i>
                <strong>Skills:</strong>
                <%= skillsToShow.join(", ") %>
                <% if (job.requiredSkills.length > 4) { %>
                  <span class="text-dark">...</span>
                  <a href="#" class="text-primary fw-medium text-decoration-none"
                     data-bs-toggle="modal" data-bs-target="#skillsModal-<%= job._id %>">
                    View all
                  </a>
                <% } %>
              </p>

              <!-- Deadline -->
              <p class="mb-2 text-muted">
                <i class="bi bi-calendar me-1"></i>
                Deadline: <%= job.deadline.toDateString() %>
              </p>

              <!-- Short Description -->
              <p class="card-text text-muted mb-3" style="flex-grow: 1;">
                <%= shortDesc %>
                <% if (job.description && job.description.split(" ").length > 20) { %>
                  <a href="#" 
                     class="text-primary fw-medium text-decoration-none view-more-link"
                     data-bs-toggle="modal"
                     data-bs-target="#jobModal-<%= job._id %>">
                    View more <i class="bi bi-arrow-right-short"></i>
                  </a>
                <% } %>
              </p>

              <!-- Apply Button -->
              <% if (currUser.role === "Freelancer") { %>
                <div class="d-flex gap-2 mt-auto">
                  <form action="/jobs/<%= job._id %>/apply" method="GET" class="flex-fill">
                    <button type="submit" class="btn btn-outline-success w-100">Apply</button>
                  </form>
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Modal for Full Job Description -->
        <% if (job.description && job.description.split(" ").length > 20) { %>
        <div class="modal fade" id="jobModal-<%= job._id %>" tabindex="-1" aria-labelledby="jobModalLabel-<%= job._id %>" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="jobModalLabel-<%= job._id %>"><%= job.title %>Full Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p><%= job.description %></p>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Modal for Full Skills List -->
        <% if (job.requiredSkills.length > 4) { %>
        <div class="modal fade" id="skillsModal-<%= job._id %>" tabindex="-1" aria-labelledby="skillsModalLabel-<%= job._id %>" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="skillsModalLabel-<%= job._id %>">All Required Skills</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <ul class="list-unstyled mb-0">
                  <% job.requiredSkills.forEach(skill => { %>
                    <li><i class="bi bi-check-circle-fill text-success me-2"></i><%= skill %></li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <% } %>

      <% } %> <!-- End if Open -->
      <% }) %>
    <% } else { %>
      <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
          <i class="bi bi-info-circle me-2"></i>No job listings found matching your search criteria.
        </div>
      </div>
    <% } %>
  </div>
</div>
